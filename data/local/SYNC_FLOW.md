# 扫描-索引-刮削任务编排流程

## 概述

本文档描述本地漫画库的同步流程，包括扫描、索引更新和元数据刮削三个主要阶段。

## 核心组件

### 1. LocalScanner（扫描器）
- **职责**：扫描本地文件系统，识别漫画、章节、页面
- **输入**：LibraryRoot（根目录）、ScanType（扫描类型）
- **输出**：ScanResult（漫画、章节、页面列表）
- **特性**：
  - 支持全量扫描和增量扫描
  - 进度回调支持
  - 平台相关实现（Android SAF / iOS Files）

### 2. IndexUpdateManager（索引更新管理器）
- **职责**：将扫描结果更新到数据库索引
- **输入**：扫描结果（漫画、章节、页面）
- **输出**：UpdateResult（更新统计）
- **特性**：
  - 增量更新（对比现有索引）
  - 批量提交（避免内存溢出）
  - 级联删除（清理不存在的数据）
  - 孤立数据清理

### 3. LocalScrapeQueue（刮削队列）
- **职责**：管理元数据刮削任务
- **输入**：漫画 ID、标题、刮削类型
- **输出**：任务 ID
- **特性**：
  - 优先级队列
  - 自动重试（最多 3 次）
  - 任务去重
  - 状态追踪

### 4. SyncOrchestrator（同步编排器）
- **职责**：协调整个同步流程
- **特性**：
  - 串行执行扫描-索引-刮削
  - 进度回调
  - 错误处理
  - 超时控制

## 流程详解

### 阶段 1: 扫描（Scanning）

```
用户触发同步
    ↓
SyncOrchestrator.syncRoot()
    ↓
LocalScanner.scanRoot()
    ↓
遍历根目录
    ↓
识别漫画（一级文件夹）
    ↓
识别章节（子文件夹/CBZ）
    ↓
识别页面（图片文件）
    ↓
返回 ScanResult
```

**扫描规则**：
- 漫画：一级文件夹
- 章节：漫画下的子文件夹或 CBZ 文件
- 页面：章节内的图片文件（jpg/jpeg/png/webp）
- 排序：按文件名自然排序
- 过滤：忽略隐藏文件（. 开头）

**增量扫描优化**：
- 检查目录/文件的最后修改时间
- 仅扫描有变化的部分
- 跳过已缓存且未变化的内容

### 阶段 2: 索引更新（Indexing）

```
接收 ScanResult
    ↓
IndexUpdateManager.updateIndexBatch()
    ↓
查询现有索引
    ↓
对比差异
    ↓
计算增删改
    ↓
分批提交（默认 50 条/批）
    ↓
更新漫画表 → 更新章节表 → 更新页面表
    ↓
级联删除不存在的数据
    ↓
返回 UpdateResult
```

**更新策略**：

1. **新增**：扫描到但索引中不存在
   - 生成唯一 ID（URI 哈希）
   - 设置创建时间戳
   - 插入数据库

2. **更新**：扫描到且索引中已存在
   - 对比更新时间戳
   - 更新变化字段
   - 更新 updated_at

3. **删除**：索引中存在但扫描结果中不存在
   - 级联删除子数据
   - 从数据库移除

**批量提交**：
- 避免一次性加载大量数据到内存
- 支持进度回调
- 事务保证原子性

### 阶段 3: 刮削入队（Scraping）

```
接收索引更新结果
    ↓
识别新增漫画
    ↓
LocalScrapeQueue.enqueueAll()
    ↓
检查任务去重
    ↓
创建 ScrapeTask
    ↓
按优先级排序
    ↓
后台执行器处理
    ↓
调用在线 API 获取元数据
    ↓
更新漫画信息
    ↓
标记任务完成
```

**刮削配置**：
- **enableAutoScrape**：是否自动刮削新增漫画
- **scrapeType**：METADATA（仅元数据）、COVER（仅封面）、FULL（完整）
- **priority**：优先级（用户手动触发 > 自动触发）

**重试机制**：
- 最大重试次数：3 次
- 失败后重新入队
- 达到最大次数后标记为 FAILED

**任务去重**：
- 基于 comicId + scrapeType 去重
- 已有待处理任务时，不重复入队

## 完整流程图

```
┌─────────────────────────────────────────────────────────────┐
│                     SyncOrchestrator                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 获取 LibraryRoot                                        │
│     ↓                                                       │
│  2. 验证权限                                                │
│     ↓                                                       │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 扫描阶段 (Scanning)                                   │  │
│  │  - LocalScanner.scanRoot()                           │  │
│  │  - 返回 ScanResult                                   │  │
│  └──────────────────────────────────────────────────────┘  │
│     ↓                                                       │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 索引更新阶段 (Indexing)                               │  │
│  │  - IndexUpdateManager.updateIndexBatch()             │  │
│  │  - 增量更新数据库                                     │  │
│  │  - 返回 UpdateResult                                 │  │
│  └──────────────────────────────────────────────────────┘  │
│     ↓                                                       │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 刮削入队阶段 (Scraping)                               │  │
│  │  - LocalScrapeQueue.enqueueAll()                     │  │
│  │  - 为新增漫画创建刮削任务                             │  │
│  │  - 返回任务 ID 列表                                   │  │
│  └──────────────────────────────────────────────────────┘  │
│     ↓                                                       │
│  3. 更新 LibraryRoot 扫描信息                               │
│     ↓                                                       │
│  4. 返回 SyncResult                                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘

                          ↓ (异步)

┌─────────────────────────────────────────────────────────────┐
│                  后台刮削执行器                              │
├─────────────────────────────────────────────────────────────┤
│  1. 从队列获取任务 (dequeue)                                 │
│  2. 调用在线 API 搜索/获取元数据                             │
│  3. 更新漫画信息                                            │
│  4. 标记任务完成/失败                                        │
│  5. 失败时重试（最多 3 次）                                  │
└─────────────────────────────────────────────────────────────┘
```

## 错误处理

### 扫描阶段错误
- **权限丢失**：标记根目录不可用，通知用户重新授权
- **文件系统错误**：跳过问题文件，记录日志，继续扫描
- **超时**：取消扫描，保留已扫描部分

### 索引更新阶段错误
- **数据库错误**：回滚事务，返回错误
- **约束冲突**：跳过冲突项，继续更新

### 刮削阶段错误
- **网络错误**：标记任务失败，等待重试
- **API 限流**：延迟重试
- **匹配失败**：标记任务完成（无匹配）

## 性能优化

### 扫描优化
- 增量扫描（基于修改时间）
- 并发扫描多个章节
- 懒加载页面列表

### 索引优化
- 批量提交（默认 50 条/批）
- 索引优化（URI、comicId、chapterId）
- 事务合并

### 刮削优化
- 优先级队列（用户手动触发优先）
- 并发执行（最多 3 个任务）
- 请求去重

## 触发方式

### 1. 手动触发
- 用户在 UI 点击"刷新"按钮
- 全量扫描或增量扫描
- 立即执行

### 2. 自动触发（前台）
- 进入本地库页面时
- 增量扫描
- 仅扫描启用自动同步的根目录

### 3. 后台任务触发
- Android: WorkManager 定期触发
- iOS: BGTaskScheduler 触发
- 增量扫描
- 系统资源允许时执行

## 数据一致性

### 原子性保证
- 索引更新使用事务
- 扫描失败不影响现有索引
- 部分更新失败可回滚

### 并发控制
- 同一根目录同时只能有一个扫描任务
- 使用锁或任务队列防止并发

### 数据校验
- URI 唯一性约束
- 外键约束（章节 → 漫画，页面 → 章节）
- 级联删除

## 监控与日志

### 关键指标
- 扫描耗时
- 发现的漫画/章节/页面数量
- 索引更新统计（增删改）
- 刮削成功率

### 日志记录
- 扫描开始/结束
- 索引更新操作
- 刮削任务状态变化
- 错误详情

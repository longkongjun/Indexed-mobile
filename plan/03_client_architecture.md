# 客户端架构设计

依据 [产品立项说明](./00_project_overview.md)：**客户端**作为资源**使用端**，支持**多端访问、同步**。不承担资源识别、分类、整理逻辑，**不从客户端上传资源**（资源由服务端/管理员侧接入），该部分由服务端完成。

---

## 模块说明

| 模块 | 职责 |
|------|------|
| **页面/屏幕** | 资源库列表、详情、阅读/播放、设置等 UI |
| **ViewModel** | 界面状态、用户操作、调用用例，不直接访问网络 |
| **用例** | 获取资源列表、资源详情、同步进度等业务编排 |
| **领域模型** | 资源、元数据、用户等与 UI、API 解耦的模型 |
| **远程 API 客户端** | 调用服务端 REST/WebSocket，封装请求与错误 |
| **本地缓存** | 列表/详情缓存、离线可读、同步元数据等 |
| **网络** | HTTP 客户端、重试、超时 |
| **认证** | Token 存储、刷新、请求头附加 |

---

## 功能说明（能做什么）

以下按用户视角与模块列出客户端可执行的具体能力，供产品与开发对齐范围。

### 浏览与消费
- **资源库列表**：按类型（漫画/影视/音乐/小说）查看资源列表，支持筛选、排序、搜索；列表数据可来自服务端或本地缓存（含离线已缓存项）。
- **资源详情**：查看单个资源的元数据（标题、封面、作者、简介、标签等）、章节/集数/曲目结构，以及阅读进度、收藏状态。
- **阅读/播放**：打开漫画章节逐页阅读（支持翻页、缩放、进度记忆）；播放影视/音乐（进度、倍速、字幕等依平台能力）；打开小说章节阅读。
- **进度与状态同步**：阅读/播放进度、书签、收藏状态在多端间同步（依赖服务端 API 与账号）；离线时本地记录，联网后上报。

### 账号与连接
- **登录/登出**：使用账号密码或 Token 登录服务端，登出时清除本地 Token 与敏感缓存。
- **服务地址配置**：配置自部署服务端的 Base URL（及可选端口、HTTPS）；连接检测与错误提示（无法连接、证书错误等）。
- **Token 刷新**：在 Token 过期前或收到 401 时自动刷新，减少用户重复登录；刷新失败时引导重新登录。

### 本地与离线
- **本地缓存**：对资源列表、详情、章节结构等做本地缓存，减少请求、加快二次打开；可配置缓存策略（如仅 Wi‑Fi 预加载、缓存上限）。
- **离线可读**：对已缓存或已下载的章节/文件，在无网时仍可阅读或播放；离线行为与“仅使用服务端”模式可配置或自动切换。
- **用户偏好**：主题、语言、阅读方向、默认画质/音质等保存在本地或随账号同步（依实现）。

### 设置与关于
- **通用设置**：网络策略（仅 Wi‑Fi 下载、流量提醒）、通知开关、存储占用查看与清理缓存入口。
- **关于与反馈**：版本号、开源许可、隐私说明、反馈/问题上报入口（若提供）。

### 与后台的关系
- 客户端**不直接访问后台**；管理员通过浏览器打开 Web 后台，在后台中配置规则、插件、元数据源等，配置保存在服务端，客户端仅使用服务端提供的资源与 API。

---

## 技术选型

| 类别 | 选型 | 说明 |
|------|------|------|
| **跨平台** | Kotlin Multiplatform (KMP) | 共享业务逻辑与部分 UI（Android / iOS / Desktop / Web） |
| **UI** | Compose Multiplatform | Android / Desktop / Web 共用 UI；iOS 可用 Compose 或 UIKit 适配 |
| **架构** | 分层（表现 / 领域 / 数据）+ 单向数据流 | ViewModel 驱动 UI，用例驱动数据 |
| **网络** | Ktor Client | 与 KMP 一致，支持多平台 |
| **本地存储** | SQLDelight 或 DataStore + 缓存策略 | 列表/详情缓存、用户偏好 |
| **依赖注入** | Koin | 轻量，KMP 友好 |
| **鸿蒙** | 独立工程，ArkTS + ArkUI | 与 KMP 共享 API 契约与部分设计，不共享代码 |

---

## 与服务端、后台的边界

- **对服务端**：仅通过 API 拉取资源与元数据、同步状态；不做识别/分类/整理，不上传资源。
- **对后台**：无直接通信；用户通过浏览器访问 Web 后台，后台再调用服务端配置 API。

---

**最后更新**：2026-01-30 · 版本 1.0.0

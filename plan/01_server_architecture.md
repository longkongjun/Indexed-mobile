# 服务端架构设计

依据 [产品立项说明](./00_project_overview.md)：服务端负责**资源识别、分类、整理**，以及**存储资源与元数据**。客户端与自部署服务端配套使用，资源存于服务端。本文档按**个人本地部署**场景设计，不依赖 Redis、对象存储等额外中间件。

---

## 模块说明

| 模块 | 职责 |
|------|------|
| **API 网关** | 路由、鉴权、协议统一 |
| **认证服务** | 用户/Token 认证、权限校验（单用户可简化） |
| **资源管理服务** | 资源 CRUD、列表/详情、与识别/整理流程编排 |
| **插件服务** | 插件注册、加载、配置；资源类型扩展 |
| **规则引擎服务** | 规则配置执行、分类与整理策略 |
| **元数据服务** | 元数据刮削、写入数据库；热点可内存缓存，无需独立缓存服务 |
| **存储服务** | 文件上传/下载、读写本地库根目录（文件系统） |
| **扫描/识别** | 根据资源类型识别文件、生成资源记录 |
| **分类/整理** | 按规则分类、重命名、归档等 |

---

## 功能说明（能做什么）

以下按模块列出服务端可执行的具体能力，供产品与开发对齐范围。

### API 网关
- 接收客户端与后台的 HTTP/WebSocket 请求，按路径路由到认证、资源、插件、元数据、存储等业务服务。
- 在进入业务前做鉴权：校验 Token、可选 IP/限流，未通过则返回 401/403。
- 统一协议：请求/响应格式、错误码与错误体、CORS；可选 API 版本前缀（如 `/api/v1`）。

### 认证服务
- 校验登录请求（账号密码或已有 Token），签发 JWT 或会话 Token；支持 Token 刷新与登出失效（若多用户）。
- 对需要鉴权的接口校验 Token，解析用户/角色，供下游服务做权限判断；单用户部署时可简化为固定 Token 或关闭鉴权。

### 资源管理服务
- 提供资源的 CRUD API：创建/更新/删除资源记录，查询资源列表（分页、筛选、排序）与详情。
- 编排「扫描 → 索引更新 → 刮削入队」流程：触发全量/增量扫描、将扫描结果与库内数据 diff 后写库、为新增资源入队刮削任务。
- 暴露任务状态与进度（扫描任务、刮削任务）供客户端或后台展示；可选 WebSocket 推送进度。
- 管理库根目录配置：列表、新增、修改、删除（与存储服务配合校验路径可达性）。

### 插件服务
- 管理插件生命周期：注册、加载、启用/禁用、卸载；插件包来自后台上传或指定路径，校验兼容性后加载。
- 存储与提供插件配置：每个插件的参数由后台配置，服务端按资源类型调用对应插件（识别、刮削、整理等）。
- 扩展资源类型：通过插件声明新类型（如自定义漫画子类型），与规则引擎、元数据源配置联动。

### 规则引擎服务
- 加载并执行规则配置：按优先级与作用范围（全局、资源类型、库根）匹配资源，执行命名、分类、移动、打标签等动作。
- 在整理流程中由资源管理服务或整理阶段调用：根据扫描/刮削结果与规则产出目标路径与元数据变更，再调用存储服务执行移动/重命名。
- 支持规则测试接口：对示例路径或资源执行规则，返回预览结果（若后台需要）。

### 元数据服务
- 执行刮削任务：根据资源类型与配置的元数据源（本地文件、TMDB、豆瓣、MAL、MusicBrainz 等）拉取元数据，写入数据库。
- 多源与优先级：按配置顺序调用多个源，命中则写入并可选缓存；支持 API Key、Base URL 等配置。
- 热点数据内存缓存（可选）：对高频访问的元数据做进程内缓存，减少数据库与外部 API 压力；单机部署无需独立 Redis。

### 存储服务
- 读写库根目录：按配置的库根路径访问本地文件系统，执行文件列表、读流、写流、删除、移动、重命名等。
- 对外暴露「下载/流式读取」接口：客户端请求资源文件时，根据资源记录中的路径或对象标识返回文件流（含范围请求、Content-Type）。
- 若支持从服务端侧接入资源：提供上传接口（供管理员或后台导入），支持分片、校验、落盘到库根下指定路径，并通知资源管理服务做后续识别/索引。

### 扫描/识别
- 遍历库根（或指定子路径），按资源类型插件识别文件与目录结构，产出「资源 → 章节/集 → 文件」等结构化结果。
- 支持全量扫描与增量扫描（如基于 mtime 或事件）；将结果交给资源管理服务做索引 diff 与写库。
- 识别过程不修改文件内容，仅读元数据与目录结构；识别规则由插件与资源类型配置决定。

### 分类/整理
- 根据规则引擎输出的目标路径与命名，调用存储服务执行移动、重命名、归档；必要时更新数据库中的路径与关联关系。
- 与扫描、刮削协同：可在刮削完成后自动触发整理（如按作品名/季集重命名），或由后台/定时任务触发。
- 保证操作可重试与一致性：先写临时位置再 rename、失败可回滚或标记待重试，避免库内数据与磁盘不一致。

---

## 技术选型（个人本地部署）

| 类别 | 选型 | 说明 |
|------|------|------|
| **API 框架** | Ktor (Kotlin) | 异步、轻量、易与 Kotlin 生态集成 |
| **业务语言** | Kotlin | 与客户端共享模型与协议 |
| **数据库** | SQLite（推荐）/ PostgreSQL | 单机推荐 SQLite，单文件、零运维；资源/元数据/规则/任务均落库 |
| **资源文件存储** | 本地文件系统 | 指定库根目录，上传与整理结果直接读写目录，无需对象存储 |
| **异步任务** | 进程内协程/线程池 | 扫描、刮削、整理在进程内异步执行，无需 RabbitMQ/Redis |
| **部署** | 单进程 / Docker（可选） | 本地单进程即可；需要时可 Docker 打包 |

---

## 与客户端、后台的边界

- **对客户端**：提供 REST/WebSocket API，用于拉取资源列表与详情、同步状态；不承担 UI 与本地扫描逻辑，不接收客户端上传（资源由服务端/管理员侧接入）。
- **对后台**：提供配置类 API（规则、插件、元数据源等），由后台调用并持久化到服务端存储。

---

**最后更新**：2026-01-30 · 版本 1.0.0
